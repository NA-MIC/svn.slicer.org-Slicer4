/*=auto=========================================================================

Portions (c) Copyright 2005 Brigham and Women's Hospital (BWH) All Rights Reserved.

See Doc/copyright/copyright.txt
or http://www.slicer.org/copyright/copyright.txt for details.

Program:   3D Slicer
Module:    $RCSfile: vtkVolumeRenderingModuleGUI.h,v $
Date:      $Date: 2006/03/19 17:12:29 $
Version:   $Revision: 1.3 $

=========================================================================auto=*/
#ifndef __vtkVolumeRenderingModuleGUI_h
#define __vtkVolumeRenderingModuleGUI_h

#include "vtkSlicerModuleGUI.h"
#include "vtkVolumeRenderingModule.h"
#include "vtkVolumeRenderingModuleLogic.h"

#include "vtkMRMLVolumeRenderingNode.h"
#include "vtkSlicerNodeSelectorWidget.h"
#include "vtkSlicerNodeSelectorVolumeRenderingWidget.h"
#include "vtkSlicerVolumePropertyWidget.h"
#include "vtkKWLabel.h"
#include "vtkKWHistogram.h"
#include "vtkKWEntryWithLabel.h"
#include "vtkKWTkUtilities.h"
#include "vtkSlicerLabelMapWidget.h"
#include <string>

class vtkVolumeTextureMapper3D;
class vtkFixedPointVolumeRayCastMapper;
class VTK_VOLUMERENDERINGMODULE_EXPORT vtkVolumeRenderingModuleGUI :public vtkSlicerModuleGUI
{
public:

    //Schedule the Render
    void ScheduleRender(void);

    static vtkVolumeRenderingModuleGUI *New();
    vtkTypeMacro(vtkVolumeRenderingModuleGUI,vtkSlicerModuleGUI);

    void PrintSelf(ostream& os, vtkIndent indent);

    // Description: Get/Set module logic
    vtkGetObjectMacro (Logic, vtkVolumeRenderingModuleLogic);
    virtual void SetLogic(vtkVolumeRenderingModuleLogic *log)
    {
        this->Logic=log;
    }
    //vtkSetObjectMacro (Logic, vtkVolumeRenderingModuleLogic);
    // Description:
    // Create widgets
    virtual void BuildGUI ( );

    // Description:
    // This method releases references and key-bindings,
    // and optionally removes observers.
    virtual void TearDownGUI ( );

    // Description:
    // Methods for adding module-specific key bindings and
    // removing them.
    virtual void CreateModuleEventBindings ( );
    virtual void ReleaseModuleEventBindings ( );

    // Description:
    // Add obsereves to GUI widgets
    virtual void AddGUIObservers ( );

    // Description:
    // Remove obsereves to GUI widgets
    virtual void RemoveGUIObservers ( );
    virtual void RemoveMRMLNodeObservers ( );
    virtual void RemoveLogicObservers ( );

    // Description:
    // Process events generated by Logic
    virtual void ProcessLogicEvents ( vtkObject *caller, unsigned long event,
        void *callData ){};

    // Description:
    // Process events generated by GUI widgets
    virtual void ProcessGUIEvents ( vtkObject *caller, unsigned long event,
        void *callData );

    // Description:
    // Process events generated by MRML
    virtual void ProcessMRMLEvents ( vtkObject *caller, unsigned long event, 
        void *callData);


    // Description:
    // Methods describe behavior at module enter and exit.
    virtual void Enter ( );
    virtual void Exit ( );


    // Description:
    // Get/Set the main slicer viewer widget, for picking
    vtkGetObjectMacro(ViewerWidget, vtkSlicerViewerWidget);
    virtual void SetViewerWidget(vtkSlicerViewerWidget *viewerWidget);

    // Description:
    // Get/Set the slicer interactorstyle, for picking
    vtkGetObjectMacro(InteractorStyle, vtkSlicerViewerInteractorStyle);
    virtual void SetInteractorStyle(vtkSlicerViewerInteractorStyle *interactorStyle);

    vtkSetMacro(PipelineInitialized,int);
    vtkGetMacro(PipelineInitialized,int);
    vtkBooleanMacro(PipelineInitialized,int);

    vtkGetMacro(EventsPending, int);
    vtkSetMacro(EventsPending, int);


    // Description:
    // Get methods on class members ( no Set methods required. )
    vtkGetObjectMacro (PB_Testing,vtkKWPushButton);
    vtkGetObjectMacro (PB_CreateNewVolumeRenderingNode,vtkKWPushButton);
    vtkGetObjectMacro (NS_ImageData,vtkSlicerNodeSelectorWidget);
    vtkGetObjectMacro (NS_VolumeRenderingDataSlicer,vtkSlicerNodeSelectorVolumeRenderingWidget);
    vtkGetObjectMacro (NS_VolumeRenderingDataScene,vtkSlicerNodeSelectorVolumeRenderingWidget);
    vtkGetObjectMacro (EWL_CreateNewVolumeRenderingNode,vtkKWEntryWithLabel);
    vtkGetObjectMacro (detailsFrame,vtkSlicerModuleCollapsibleFrame);
    vtkGetObjectMacro (LM_OptionTree,vtkSlicerLabelMapWidget);
    vtkGetObjectMacro (Histograms,vtkKWHistogramSet);
    vtkGetObjectMacro (SVP_VolumeProperty,vtkSlicerVolumePropertyWidget);
    vtkGetObjectMacro (currentNode,vtkMRMLVolumeRenderingNode);
    vtkGetObjectMacro (presets, vtkMRMLScene);
    vtkGetObjectMacro (volume,vtkVolume);





protected:
    vtkVolumeRenderingModuleGUI();
    ~vtkVolumeRenderingModuleGUI();
    vtkVolumeRenderingModuleGUI(const vtkVolumeRenderingModuleGUI&);//not implemented
    void operator=(const vtkVolumeRenderingModuleGUI&);//not implemented

    // Description:
    // Updates GUI widgets based on parameters values in MRML node
    void UpdateGUI();

    // Description:
    // Updates parameters values in MRML node based on GUI widgets 
    void UpdateMRML();

    // Description:
    // GUI elements

    // Description:
    // Pointer to the module's logic class
    vtkVolumeRenderingModuleLogic *Logic;

    // Description:
    // A pointer back to the viewer widget, useful for picking
    vtkSlicerViewerWidget *ViewerWidget;

    // Description:
    // A poitner to the interactor style, useful for picking
    vtkSlicerViewerInteractorStyle *InteractorStyle;

    int PipelineInitialized;//0=no,1=Yes
    void InitializePipelineNewCurrentNode();
    void InitializePipelineFromMRMLScene();
    void InitializePipelineFromSlicer();
    void InitializePipelineFromImageData();
    void LabelMapInitializePipelineNewCurrentNode();
    void LabelMapInitializePipelineFromMRMLScene();
    void LabelMapInitializePipelineFromSlicer();
    void LabelMapInitializePipelineFromImageData();
    void UpdateSVP();
    void UpdateLM();
    void ShutdownPipeline();
    void Rendering(void);
    void UpdateRendering(void);
    void  CheckAbort(void);
    void AdjustMapping();

    //OWN GUI Elements

    //Frame Save/Load
    vtkKWPushButton *PB_Testing;
    vtkKWPushButton *PB_CreateNewVolumeRenderingNode;
    vtkSlicerNodeSelectorWidget *NS_ImageData;
    //BTX
    std::string PreviousNS_ImageData;
    std::string PreviousNS_VolumeRenderingSlicer;
    std::string PreviousNS_VolumeRenderingDataScene;
    //ETX
    vtkSlicerNodeSelectorVolumeRenderingWidget *NS_VolumeRenderingDataSlicer;
    vtkSlicerNodeSelectorVolumeRenderingWidget *NS_VolumeRenderingDataScene;
    vtkKWEntryWithLabel *EWL_CreateNewVolumeRenderingNode;

    //Frame Details
    vtkSlicerModuleCollapsibleFrame *detailsFrame;
    //For Labelmaps
    vtkSlicerLabelMapWidget *LM_OptionTree;
    //For normal
    vtkKWHistogramSet *Histograms;
    vtkSlicerVolumePropertyWidget *SVP_VolumeProperty;

    //Other members
    vtkMRMLVolumeRenderingNode  *currentNode;
    vtkMRMLScene *presets;

    //Rendering pipeline
    vtkVolume *volume;


    //That's all for Speed optimization ->Own class?!
    vtkRenderer *renViewport;
    vtkRenderer *renPlane;
    int RenderPlane;
    vtkVolumeTextureMapper3D *MapperTexture;
    vtkFixedPointVolumeRayCastMapper *MapperRaycast;

    //Initial Factor for Interactive Rendering
    double InitialDropLowRes;
    //Factor during last low Resolution Rendering
    double FactorLastLowRes;
    //Time for the last High Resolution Rendering
    double LastTimeHighRes;
    //Time for the last Low Resolution Rendering
    double LastTimeLowRes;
    //Timer
    vtkTimerLog *timer;
    //Which time would we like to achieve
    double GoalLowResTime;
    //Area in which no change in Factor will be made.
    int PercentageNoChange;
    //How long to wait, before Rendering in High Resolution
    double TimeToWaitForHigherStage;
    //0 interactive, 1 High Resolution Texture VR, 2 SW Ray Cast
    int currentStage;

    int scheduled;
    //Flag if next Render is a High Resolution Render
    int NextRenderHighResolution;
    //BTX
    std::string EventHandlerID;
    //ETX



    //
    vtkKWTkUtilities *Utilities;

    //Callbacks
    void SetInVolumeRenderingCallbackFlag (int flag) {
        this->InVolumeRenderingCallbackFlag = flag;
    }
    vtkGetMacro(InVolumeRenderingCallbackFlag, int);
    vtkCallbackCommand* VolumeRenderingCallbackCommand;
    int InVolumeRenderingCallbackFlag;
    static void VolumeRenderingCallback( vtkObject *__caller,unsigned long eid, void *__clientData, void *callData );
    void ProcessVolumeRenderingEvents(vtkObject *caller,unsigned long eid,void *callData);

    void PackLabelMapGUI(void);
    void UnpackLabelMapGUI(void);

    void PackSvpGUI(void);
    void UnpackSvpGUI(void);
    int counter;

    


    // Description:
    // 1 if the tcl event queue has pending events (call CheckForPendingEvents 
    // and then look at the value of EventsPending)
    int CheckForPendingEvents();


    int EventsPending;
};

#endif
